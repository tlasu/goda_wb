# goda-wb スキルシート

## プロジェクト概要

合田の砕波変形モデル（Goda's breaking wave deformation model）の Python 実装。
海岸工学における波浪変形計算のためのライブラリで、浅水域での波高変化・砕波変形を数値的に計算する。

## 技術スタック

| カテゴリ | 技術 |
|---|---|
| 言語 | Python 3.11+ |
| パッケージ管理 | uv (uv_build) |
| 依存ライブラリ | numpy, pandas |
| テスト | pytest (50テスト) |
| リンター/フォーマッター | ruff |
| CI/CD | GitHub Actions (lint + test, Python 3.11/3.12/3.13) |
| ライセンス | MIT |

## ディレクトリ構成

```
goda_wb/
├── src/goda_wb/          # メインパッケージ
│   ├── __init__.py
│   ├── core.py           # 計算ロジック本体
│   └── constant.py       # 物理定数・モデルパラメータ
├── test/
│   └── test_core.py      # テストスイート
├── sample/               # 使用例・可視化スクリプト
├── .github/workflows/
│   └── ci.yml            # CI パイプライン
├── pyproject.toml
└── README.md
```

## パッケージ構成

### `goda_wb.constant` - 定数・パラメータ

| 定数 | 説明 |
|---|---|
| `pi2` | 2π |
| `g` | 重力加速度 (9.81 m/s^2) |
| `MP` | 波高確率密度分布の離散点数 (51) |
| `NWAVE` | 代表波高の種類数 (7) |
| `CONVERGENCE_TOL` | ニュートン法の収束判定閾値 |
| `GAUSS_HERMITE_ABSCISSAE` / `WEIGHTS` | ガウス-エルミート求積法の点と重み (8点) |
| `REPRESENTATIVE_WAVE_PROBABILITIES` | 各代表波高に対応する超過確率 |
| `goda_dl0_list` | デフォルトの水深波長比リスト (114点) |

### `goda_wb.core` - パブリック API

#### `cal_surf_goda(tant, h0l0, dl0=None) -> DataFrame`

メイン関数。合田の砕波変形モデルによる代表波高比の計算。

- **入力**: 海底勾配 `tant`、波形勾配 `h0l0`、水深波長比リスト `dl0`
- **出力**: H1/1000, H1/250, H1/100, H1/50, H1/10, H1/5, H1/3 等を含む DataFrame

#### `cal_surf_goda_dim(tant, H0, T, dim=False, d=None) -> DataFrame`

有次元入力（波高 [m]、周期 [s]、水深 [m]）に対応したラッパー。

#### `cal_surf_goda_point(tant, h0l0, dl0) -> DataFrame`

単一水深での計算。

#### `shoal(dl0, h0l0) -> float`

浅水変形係数の計算。3つの領域（微小振幅波理論 / べき乗則遷移 / 砕波後散逸）を切り替える。

#### `aksi(dl0) -> float`

微小振幅波理論に基づく浅水係数の算出。

#### `cal_wave_length(d, T) -> float`

水深と周期から波長を計算（分散関係の反復解法）。

#### `wave(d) -> float`

分散関係 `x * tanh(x) = d` を反復法（ニュートン法）で解く基礎関数。

### 内部関数

| 関数 | 役割 |
|---|---|
| `etai()` | セットアップ量の線形外挿初期値推定 |
| `sbeat()` | サーフビートによる水位変動（ガウス求積法） |
| `bindx()` | 砕波限界指標の算出 |
| `setup()` | エネルギーフラックス保存によるセットアップ計算 |
| `out()` | 波高確率密度分布からの代表波高算出 |
| `prob()` | レイリー分布 + 砕波限界切断による確率密度構築 |
| `prob01()` | 確率密度分布の正規化 |

## 計算フローの概要

```
入力: 海底勾配(tant), 波形勾配(h0l0), 水深波長比リスト(dl0)
  ↓
各水深について:
  1. shoal()     → 浅水係数 Ks の算出
  2. etai()      → セットアップ初期値の外挿
  3. sbeat()×8   → サーフビート水位変動（8点ガウス求積）
  4. bindx()     → 各水位変動での砕波限界
  5. prob()×8    → 波高確率密度分布の構築
  6. prob01()    → 確率密度の正規化
  7. setup()     → セットアップ量の更新
  8. out()       → 代表波高比の算出
  ↓
出力: DataFrame (H1/3, H1/10, ... , 浅水係数, セットアップ等)
```

## テスト

50テストケースで以下をカバー:

- **`wave()`**: 分散関係の検証、境界値 (d=0.01~10.01)、深水条件、不正入力
- **`aksi()`**: 正値性、深水条件 (≈1)、不正入力
- **`cal_wave_length()`**: 深水波長一致、浅水での短波長化、不正入力
- **`shoal()`**: 正値性、深水域での aksi 一致、異なる波形勾配、不正入力
- **`cal_surf_goda()`**: DataFrame 形状、期待値との回帰テスト、デフォルト dl0、不正入力、H1/3 ≤ H1/1000
- **`cal_surf_goda_dim()`**: 基本動作、dim フラグ、単一/リスト水深、スケーリング一致、不正入力
- **`sbeat()`**: 不正インデックス、確率の正値性

## 理論的背景

合田良実（1975）の砕波変形モデルに基づく。主な理論要素:

- **微小振幅波理論**: 分散関係の反復解法による波長・浅水係数の算出
- **合田の浅水変形モデル**: 3領域（線形浅水、遷移、砕波後）の浅水係数
- **砕波限界式**: 海底勾配を考慮した合田の砕波限界波高式
- **波高確率密度分布**: レイリー分布をベースに砕波限界による切断を適用
- **サーフビート**: ガウス-エルミート求積法による水位変動の確率的取り扱い
- **波のセットアップ**: エネルギーフラックス保存則に基づく平均水位変動

## 参考文献

- 合田良実, "浅海域における波浪の砕波変形", 港湾空港技術研究所報告, Vol. 14, No. 3, 1975. ([全文PDF](https://www.pari.go.jp/PDF/vol014-no03-03.pdf) / [書誌情報](https://www.pari.go.jp/1975/09/1975090140303.html))
